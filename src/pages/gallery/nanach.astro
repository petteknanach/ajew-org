---
import Layout from '../../layouts/Layout.astro';
import { getImage } from 'astro:assets';
import fs from 'node:fs';
import path from 'node:path';

const imageDir = './public/images/nanach/';

// Get all images from the folder
function getAllImages() {
  try {
    const files = fs.readdirSync(imageDir);
    return files.filter(file => 
      /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(file) &&
      !file.startsWith('.')
    ).sort();
  } catch (e) {
    return [];
  }
}

const allImages = getAllImages();

// Helper function to format filename for display
function formatFilename(filename) {
  let formatted = decodeURIComponent(filename);
  formatted = formatted.replace(/\.(jpg|jpeg|png|gif|webp|svg)$/i, '');
  formatted = formatted.replace(/[-_]/g, ' ');
  formatted = formatted.replace(/\b\w/g, l => l.toUpperCase());
  return formatted;
}

// Organize images by category
const categories = {
  'graffiti': {
    name: 'Graffiti & Street Art',
    hebrew: '×’×¨×¤×™×˜×™ ×•××× ×•×ª ×¨×—×•×‘',
    icon: 'ğŸ¨',
    images: allImages.filter(img => 
      (img.includes('graffiti') || 
       img.includes('spray') ||
       img.includes('sticker') ||
       img.includes('wall') && img.includes('nanach') ||
       img.includes('brick') ||
       img.includes('painting') ||
       img.includes('paint')) &&
      !img.includes('bais') &&
      !img.includes('van') &&
      !img.includes('heart')
    )
  },
  'art': {
    name: 'Art & Paintings',
    hebrew: '××× ×•×ª ×•×¦×™×•×¨×™×',
    icon: 'ğŸ–¼ï¸',
    images: allImages.filter(img =>
      !img.includes('graffiti') &&
      !img.includes('spray') &&
      !img.includes('sticker') &&
      !img.includes('wall') &&
      !img.includes('van') &&
      !img.includes('heart') &&
      !img.includes('portrait') &&
      !img.includes('face') &&
      !img.includes('friend') &&
      !img.includes('simcha') &&
      !img.includes('kotel') &&
      !img.includes('tzion') &&
      !img.includes('bais') &&
      !img.includes('bridge') &&
      !img.includes('logo') &&
      !img.includes('sign') &&
      !img.includes('smiley') &&
      !img.includes('beanie') &&
      !img.includes('vote') &&
      !img.includes('election') &&
      !img.includes('ballot') &&
      !img.includes('transition')
    )
  },
  'bais-rabbainu': {
    name: 'Bais Rabbainu',
    hebrew: '×‘×™×ª ×¨×‘×™× ×•',
    icon: 'ğŸ•',
    images: allImages.filter(img =>
      img.includes('bais') || img.includes('synagogue')
    )
  },
  'locations': {
    name: 'Sacred Locations',
    hebrew: '××§×•××•×ª ×§×“×•×©×™×',
    icon: 'ğŸ“',
    images: allImages.filter(img =>
      (img.includes('kotel') ||
       img.includes('tzion') ||
       img.includes('arizal') ||
       img.includes('bridge') ||
       img.includes('tomb')) &&
      !img.includes('saba')
    )
  },
  'vans': {
    name: 'Na Nach Vans',
    hebrew: '×•×× ×™× ×  × ×—',
    icon: 'ğŸš',
    images: allImages.filter(img =>
      img.includes('van') || img.includes('truck') || img.includes('trailer')
    )
  },
  'events': {
    name: 'Events & Singing',
    hebrew: '××™×¨×•×¢×™× ×•×©×™×¨×”',
    icon: 'ğŸµ',
    images: allImages.filter(img =>
      img.includes('simcha') ||
      img.includes('singing') ||
      img.includes('dagan') ||
      img.includes('levi') ||
      img.includes('hochman') ||
      img.includes('rosh-hashana') ||
      img.includes('rosh hashana')
    )
  },
  'friends': {
    name: 'Friends & People',
    hebrew: '×—×‘×¨×™× ×•×× ×©×™×',
    icon: 'ğŸ‘¥',
    images: allImages.filter(img =>
      (img.includes('portrait') ||
       img.includes('face') ||
       img.includes('friend') ||
       img.includes('beanie') ||
       img.includes('yosef') ||
       img.includes('holligram') ||
       img.includes('crowned') ||
       img.includes('spangled') ||
       img.includes('self') ||
       img.includes('meir') ||
       img.includes('weiner') ||
       img.includes('gavriel') ||
       img.includes('chaim') ||
       img.includes('aron') ||
       img.includes('gil') ||
       img.includes('michol') ||
       img.includes('bar-mitzva')) &&
      !img.includes('van')
    )
  },
  'signs': {
    name: 'Signs & Symbols',
    hebrew: '×©×œ×˜×™× ×•×¡××œ×™×',
    icon: 'ğŸª§',
    images: allImages.filter(img =>
      img.includes('sign') ||
      img.includes('logo') ||
      img.includes('smiley') ||
      img.includes('transition') ||
      img.includes('election') ||
      img.includes('vote') ||
      img.includes('ballot') ||
      img.includes('neon')
    )
  },
  'hearts': {
    name: 'Hearts & Love',
    hebrew: '×œ×‘×‘×•×ª ×•××”×‘×”',
    icon: 'â¤ï¸',
    images: allImages.filter(img =>
      img.includes('heart') || img.includes('love')
    )
  },
  'saba': {
    name: 'Saba & Petek',
    hebrew: '×¡×‘× ×•×¤×ª×§',
    icon: 'âœ¡ï¸',
    images: allImages.filter(img =>
      img.includes('saba') || img.includes('petek')
    )
  }
};

// Count total categorized
const categorizedCount = Object.values(categories).reduce((sum, cat) => sum + cat.images.length, 0);
---

<Layout title="Na Nach Life Gallery" description="Photos of the Na Nach Breslov movement - graffiti, events, and daily life">
  <section class="page-header">
    <h1>âœ¡ Na Nach Breslov Movement âœ¡</h1>
    <p>Spreading the light of Rabbi Nachman throughout the world</p>
    <p class="hebrew">× Ö· × Ö·×—Ö° × Ö·×—Ö°×Ö¸ × Ö·×—Ö°×Ö¸×Ÿ ×××•Ö¼×Ö¸×Ÿ</p>
    <p class="stats">{allImages.length} images</p>
    <a href="/gallery" class="back-link">â† Back to Gallery</a>
  </section>

  <section class="intro">
    <div class="container">
      <div class="info-box">
        <h2>ğŸŒŸ The Na Nach Movement</h2>
        <p>
          The Na Nach Breslov movement was inspired by Rabbi Yisroel Ber Odesser (Saba) 
          who received the miraculous Petek in 1922. Today, Na Nach Breslover Chassidim 
          spread joy and the teachings of Rebbe Nachman worldwide through songs, gatherings, 
          and acts of kindness.
        </p>
        <p class="hebrew">
          ×ª× ×•×¢×ª ×  × ×— ××‘×¨×¡×œ×‘ ×”×ª×¤×ª×—×” ××”×¤×ª×§ ×©×§×™×‘×œ ×”×¡×‘× ×¨×‘×™ ×™×©×¨××œ ×‘×¨ ××•×“×¡×¨ ×‘×©× ×ª ×ª×¨×¤"×‘
        </p>
      </div>
      
      <div class="quick-index">
        <h3>ğŸ“‚ Quick Index</h3>
        <div class="index-links">
          {Object.entries(categories).map(([key, cat]) => (
            cat.images.length > 0 && (
              <a href={`#category-${key}`} class="index-link">
                <span class="icon">{cat.icon}</span>
                <span class="name">{cat.name}</span>
                <span class="count">{cat.images.length}</span>
              </a>
            )
          ))}
        </div>
      </div>
    </div>
  </section>

  <section class="gallery">
    <div class="container">
      {Object.entries(categories).map(([key, cat]) => (
        cat.images.length > 0 && (
          <div id={`category-${key}`} class="category-section">
            <h2><span class="icon">{cat.icon}</span> {cat.name} <span class="hebrew">({cat.hebrew})</span></h2>
            <div class="gallery-grid">
              {cat.images.map((img, index) => (
                <div class="gallery-item">
                  <img src={`/images/nanach/${img}`} alt={formatFilename(img)} loading="lazy" />
                  <div class="overlay">
                    <span>{cat.name} #{index + 1}</span>
                  </div>
                  <div class="caption">{formatFilename(img)}</div>
                </div>
              ))}
            </div>
          </div>
        )
      ))}
    </div>
  </section>

  <section class="navigation">
    <div class="container">
      <div class="nav-buttons">
        <a href="/gallery/uman" class="nav-btn prev">
          <span class="arrow">â†</span>
          <span class="text">Tomb in Uman</span>
        </a>
        <a href="/gallery/events" class="nav-btn next">
          <span class="text">Events Gallery</span>
          <span class="arrow">â†’</span>
        </a>
      </div>
    </div>
  </section>
</Layout>

<style>
  .page-header {
    background: linear-gradient(135deg, #38a169 0%, #276749 100%);
    color: white;
    padding: 5rem 2rem;
    text-align: center;
  }

  .page-header h1 {
    font-family: var(--font-hebrew);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }

  .page-header p {
    opacity: 0.9;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
  }

  .page-header .hebrew {
    font-family: var(--font-hebrew);
    font-size: 1.5rem;
    margin-top: 1rem;
    letter-spacing: 0.1em;
  }

  .page-header .stats {
    font-size: 1rem;
    opacity: 0.7;
    margin-top: 0.5rem;
  }

  .back-link {
    display: inline-block;
    margin-top: 1.5rem;
    color: white;
    text-decoration: none;
    padding: 0.75rem 1.5rem;
    border: 2px solid white;
    border-radius: 6px;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .intro {
    background: #f7f5f0;
    padding: 4rem 0;
  }

  .info-box {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
  }

  .info-box h2 {
    font-family: var(--font-hebrew);
    color: var(--color-primary);
    margin-bottom: 1rem;
  }

  .info-box p {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #555;
    margin-bottom: 1rem;
  }

  .info-box .hebrew {
    font-family: var(--font-hebrew);
    font-size: 1.3rem;
    color: #38a169;
  }

  .quick-index {
    max-width: 900px;
    margin: 2rem auto 0;
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .quick-index h3 {
    font-family: var(--font-hebrew);
    color: var(--color-primary);
    margin-bottom: 1rem;
    text-align: center;
  }

  .index-links {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
  }

  .index-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f7f5f0;
    border-radius: 8px;
    text-decoration: none;
    color: var(--color-primary);
    font-weight: 600;
    font-size: 0.9rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .index-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: #edf2f7;
  }

  .index-link .icon {
    font-size: 1.1rem;
  }

  .index-link .count {
    background: #38a169;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-right: 0.25rem;
  }

  .category-section {
    padding: 4rem 0;
    border-bottom: 1px solid #eee;
    scroll-margin-top: 2rem;
  }

  .category-section:last-child {
    border-bottom: none;
  }

  .category-section h2 {
    font-family: var(--font-hebrew);
    font-size: 1.8rem;
    color: var(--color-primary);
    margin-bottom: 2rem;
    text-align: center;
  }

  .category-section h2 .hebrew {
    font-family: var(--font-hebrew);
    font-size: 1.4rem;
    color: #888;
    font-weight: normal;
    margin-right: 0.5rem;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .gallery-item {
    position: relative;
    overflow: visible;
  }

  .gallery-item img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 12px;
    transition: transform 0.4s;
    display: block;
  }

  .gallery-item:hover img {
    transform: scale(1.08);
  }

  .gallery-item .overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 2rem 1rem 1rem;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .gallery-item:hover .overlay {
    opacity: 1;
  }

  .gallery-item .overlay span {
    color: white;
    font-size: 0.95rem;
  }

  .gallery-item .caption {
    padding: 0.75rem;
    background: #f8f8f8;
    font-size: 0.85rem;
    color: #555;
    text-align: center;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    word-break: break-word;
    line-height: 1.4;
  }

  .navigation {
    background: var(--color-primary);
    padding: 3rem 0;
  }

  .nav-buttons {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }

  .nav-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: white;
    text-decoration: none;
    padding: 1rem 1.5rem;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
  }

  .nav-btn:hover {
    background: rgba(255,255,255,0.2);
  }

  @media (max-width: 768px) {
    .nav-buttons {
      flex-direction: column;
    }
    
    .gallery-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .index-links {
      gap: 0.5rem;
    }
    
    .index-link {
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
    }
  }
</style>
